<div class="background-black">
    <div class="window-register">
        <div class="header-register">
            <button type="button" class="btn-back" (click)="currentStep === 1 ? goHome() : prevStep()">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                </svg>
            </button>

            <img (click)="goHome()" src="assets/img/LogoTreeVerdeRecortado.png" alt="Logotipo de la marca TreeLeven"
                class="img">

            <button type="button" class="btn-next" *ngIf="currentStep === 1" [disabled]="!isStep1Valid()"
                (click)="nextStep()">
                Siguiente
            </button>
            <div class="space" *ngIf="currentStep === 2"></div>
        </div>

        <!-- Indicador de pasos -->
        <div class="progress-indicator">
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
            </div>
            <p class="step-text">Paso {{ currentStep }} de {{ totalSteps }}</p>
        </div>

        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">

            <!-- PASO 1: Datos Básicos -->
            <div class="step-container" *ngIf="currentStep === 1">
                <p class="title">Crea tu cuenta</p>

                <div class="error-alert" *ngIf="edadError()">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor"
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                    </svg>
                    {{ edadError() }}
                </div>

                <!-- Nombre -->
                <div class="input-content">
                    <label for="name">Nombre</label>
                    <input type="text" id="name" formControlName="name" placeholder="Ingresa tu nombre"
                        [class.input-error]="hasError('name', 'required') || hasError('name', 'minlength')">

                    <span class="error-message" *ngIf="getErrorMessage('name')">
                        {{ getErrorMessage('name') }}
                    </span>
                </div>

                <!-- Apellido -->
                <div class="input-content">
                    <label for="lastName">Apellido</label>
                    <input type="text" id="lastName" formControlName="lastName" placeholder="Ingresa tu apellido"
                        [class.input-error]="hasError('lastName', 'required') || hasError('lastName', 'minlength')">
                    <span class="error-message" *ngIf="getErrorMessage('lastName')">
                        {{ getErrorMessage('lastName') }}
                    </span>
                </div>

                <!-- Correo -->
                <div class="input-content">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" formControlName="email" placeholder="Ingresa tu email"
                        [class.input-error]="hasError('email', 'required') || hasError('email', 'email')">
                    <span class="error-message" *ngIf="getErrorMessage('email')">
                        {{ getErrorMessage('email') }}
                    </span>
                </div>

                <!-- Fecha de nacimiento -->
                <div class="description">
                    <label>Fecha de nacimiento</label>
                    <p>Esta información no será pública. Confirma tu propia edad, incluso si esta cuenta es para una
                        empresa, una mascota u otra cosa.</p>
                </div>

                <div class="date">
                    <div class="input-content date-select">
                        <label for="month">Mes</label>
                        <select id="month" formControlName="month" [class.input-error]="hasError('month', 'required')">
                            <option value="" disabled selected>Selecciona</option>
                            <option *ngFor="let month of months" [value]="month.valor">{{ month.nombre }}</option>
                        </select>
                        <span class="error-message" *ngIf="hasError('month', 'required')">
                            Requerido
                        </span>
                    </div>

                    <div class="input-content date-select">
                        <label for="day">Día</label>
                        <select id="day" formControlName="day" [class.input-error]="hasError('day', 'required')">
                            <option value="" disabled selected>Día</option>
                            <option *ngFor="let day of days" [value]="day">{{ day }}</option>
                        </select>
                        <span class="error-message" *ngIf="hasError('day', 'required')">
                            Requerido
                        </span>
                    </div>

                    <div class="input-content date-select">
                        <label for="year">Año</label>
                        <select id="year" formControlName="year" [class.input-error]="hasError('year', 'required')">
                            <option value="" disabled selected>Año</option>
                            <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                        </select>
                        <span class="error-message" *ngIf="hasError('year', 'required')">
                            Requerido
                        </span>
                    </div>
                </div>
            </div>

            <!-- PASO 2: Información Adicional -->
            <div class="step-container" *ngIf="currentStep === 2">
                <p class="title">Completa tu perfil</p>

                <div class="error-alert" *ngIf="serverError()">
                    <svg viewBox="0 0 24 24" width="20" height="20">
                        <path fill="currentColor"
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                    </svg>
                    {{ serverError() }}
                </div>

                <!-- Nombre de usuario -->
                <div class="input-content">
                    <label for="userName">Nombre de usuario</label>
                    <input type="text" id="userName" formControlName="userName" placeholder="Ej: juan_perez123"
                        [class.input-error]="hasError('userName', 'required') || hasError('userName', 'minlength') || hasError('userName', 'pattern')">
                    <span class="error-message" *ngIf="getErrorMessage('userName')">
                        {{ getErrorMessage('userName') }}
                    </span>
                </div>

                <!-- Descripción breve -->
                <div class="input-content">
                    <label for="description">Sobre ti (opcional)</label>
                    <textarea id="description" formControlName="description" placeholder="Cuéntanos algo sobre ti..."
                        rows="3" [class.input-error]="hasError('description', 'maxlength')"></textarea>
                    <span class="char-count">{{ registerForm.get('description')?.value?.length || 0 }}/200</span>
                    <span class="error-message" *ngIf="getErrorMessage('description')">
                        {{ getErrorMessage('description') }}
                    </span>
                </div>

                <!-- Imagen de perfil -->
                <div class="input-content file-input">
                    <label for="profileImageUrl">Foto de perfil (opcional)</label>
                    <div class="file-upload-wrapper">
                        <input type="file" id="profileImageUrl" accept="image/*" (change)="onFileSelected($event)"
                            #fileInput>
                        <button type="button" class="btn-file" (click)="fileInput.click()">
                            <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 6px;">
                                <path fill="currentColor"
                                    d="M19.5 12c-2.483 0-4.5 2.015-4.5 4.5s2.017 4.5 4.5 4.5 4.5-2.015 4.5-4.5-2.017-4.5-4.5-4.5zm2.5 5h-2v2h-1v-2h-2v-1h2v-2h1v2h2v1zm-18 0l2.5-3.5 1.893 2.5 2.5-3.5L13 18H2v-1zm1-11.5C3 4.673 3.673 4 4.5 4h11c.827 0 1.5.673 1.5 1.5v7.665c-.381-.225-.803-.393-1.25-.506V5.5c0-.276-.224-.5-.5-.5h-11c-.276 0-.5.224-.5.5v11c0 .276.224.5.5.5h7.585c.137.466.337.903.594 1.297l.021.021V19H4.5C3.673 19 3 18.327 3 17.5v-12z" />
                            </svg>
                            Seleccionar imagen
                        </button>
                        <span class="file-name" *ngIf="imagenPreview()">✓ Imagen cargada</span>
                    </div>
                    <div class="image-preview" *ngIf="imagenPreview()">
                        <img [src]="imagenPreview()" alt="Preview">
                    </div>
                </div>

                <!-- Contraseña -->
                <div class="input-content">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" formControlName="password" placeholder="Mínimo 6 caracteres"
                        [class.input-error]="hasError('password', 'required') || hasError('password', 'minlength')">
                    <span class="error-message" *ngIf="getErrorMessage('password')">
                        {{ getErrorMessage('password') }}
                    </span>
                </div>

                <!-- Repetir contraseña -->
                <div class="input-content">
                    <label for="passwordConfirmation">ar contraseña</label>
                    <input type="password" id="passwordConfirmation" formControlName="passwordConfirmation"
                        placeholder="Repite tu contraseña"
                        [class.input-error]="hasError('passwordConfirmation', 'required') || getPasswordMismatchError()">
                    <span class="error-message"
                        *ngIf="getErrorMessage('passwordConfirmation') || getPasswordMismatchError()">
                        {{ getErrorMessage('passwordConfirmation') || getPasswordMismatchError() }}
                    </span>
                </div>

                <!-- Botón de envío -->
                <button type="submit" class="btn-submit" [disabled]="!isStep2Valid()">
                    Crear cuenta
                </button>
            </div>
        </form>

        <!-- Link de login -->
        <p class="login-link" *ngIf="currentStep === 1">
            ¿Ya tienes cuenta? <a [routerLink]="['/login']">Inicia sesión</a>
        </p>
    </div>

    <!-- Modal de Registro Exitoso -->
    <div class="modal-backdrop" *ngIf="showSuccessModal">
        <div class="modal">
            <h2> ¡Cuenta creada con éxito!</h2>
            <p>Tu cuenta ha sido registrada correctamente.</p>
            <button (click)="closeSuccessModal()">Continuar</button>
        </div>
    </div>
</div>