<section class="dashboard-container">
  <!-- Navbar -->
  <app-navbar></app-navbar>

  <div class="dashboard-content">
    <!-- Header -->
    <div class="dashboard-header">
      <div>
        <h1 class="dashboard-title">Gestión de Usuarios</h1>
        <p class="dashboard-subtitle">Administra los usuarios de la plataforma</p>
      </div>
      <button class="btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <line x1="19" x2="19" y1="8" y2="14"/>
          <line x1="22" x2="16" y1="11" y2="11"/>
        </svg>
        Crear Usuario
      </button>
    </div>

    <!-- Mensajes -->
    <div *ngIf="successMessage()" class="alert alert-success">
      {{ successMessage() }}
    </div>

    <div *ngIf="error() && !showCreateModal()" class="alert alert-error">
      {{ error() }}
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading()" class="loading-container">
      <div class="spinner"></div>
      <p>Cargando usuarios...</p>
    </div>

    <!-- Tabla de usuarios -->
    <div *ngIf="!isLoading()" class="users-table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users()" [class.user-disabled]="!user.active">
            <td>
              <div class="user-cell">
                <img 
                  [src]="user.profileImageUrl || 'https://via.placeholder.com/40'" 
                  [alt]="user.name"
                  class="user-avatar">
                <div class="user-info">
                  <span class="user-name">{{ user.name }} {{ user.lastName }}</span>
                  <span class="user-username">@{{ user.userName }}</span>
                </div>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
              <span class="badge" [ngClass]="getRoleBadgeClass(user.profile)">
                {{ user.profile }}
              </span>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(user.active)">
                {{ user.active ? 'Activo' : 'Deshabilitado' }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <!-- Toggle Estado -->
                <button 
                  class="btn-action btn-toggle"
                  [class.btn-enable]="!user.active"
                  [class.btn-disable]="user.active"
                  (click)="toggleUserStatus(user)"
                  [title]="user.active ? 'Deshabilitar' : 'Habilitar'">
                  <svg *ngIf="user.active" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                  </svg>
                  <svg *ngIf="!user.active" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  {{ user.active ? 'Deshabilitar' : 'Habilitar' }}
                </button>

                <!-- Toggle Rol -->
                <button 
                  class="btn-action btn-role"
                  (click)="toggleUserRole(user)"
                  title="Cambiar rol">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                  </svg>
                  Cambiar Rol
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Sin usuarios -->
      <div *ngIf="users().length === 0" class="no-users">
        <p>No hay usuarios registrados</p>
      </div>
    </div>
  </div>

  <!-- Modal de Crear Usuario -->
  <div *ngIf="showCreateModal()" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Crear Nuevo Usuario</h2>
        <button class="btn-close" (click)="closeCreateModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <!-- Mensajes del modal -->
        <div *ngIf="successMessage()" class="alert alert-success">
          {{ successMessage() }}
        </div>

        <div *ngIf="error()" class="alert alert-error">
          {{ error() }}
        </div>

        <form [formGroup]="userForm" (ngSubmit)="submitForm()">
          
          <!-- Foto de perfil -->
          <div class="form-group">
            <label>Foto de Perfil (Opcional)</label>
            <div class="file-upload">
              <input 
                type="file" 
                id="profilePicture" 
                accept="image/jpg,image/jpeg,image/png,image/webp"
                (change)="onFileSelected($event)"
                hidden>
              
              <label for="profilePicture" class="file-upload-label">
                <div *ngIf="!previewUrl" class="upload-placeholder">
                  <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  <span>Haz clic para subir una imagen</span>
                </div>
                <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="image-preview">
              </label>
            </div>
          </div>

          <!-- Nombre y Apellido -->
          <div class="form-row">
            <div class="form-group">
              <label for="name">Nombre *</label>
              <input 
                type="text" 
                id="name" 
                formControlName="name"
                [class.input-error]="getFieldError('name')">
              <span *ngIf="getFieldError('name')" class="error-message">
                {{ getFieldError('name') }}
              </span>
            </div>

            <div class="form-group">
              <label for="lastName">Apellido *</label>
              <input 
                type="text" 
                id="lastName" 
                formControlName="lastName"
                [class.input-error]="getFieldError('lastName')">
              <span *ngIf="getFieldError('lastName')" class="error-message">
                {{ getFieldError('lastName') }}
              </span>
            </div>
          </div>

          <!-- Email y Username -->
          <div class="form-row">
            <div class="form-group">
              <label for="email">Email *</label>
              <input 
                type="email" 
                id="email" 
                formControlName="email"
                [class.input-error]="getFieldError('email')">
              <span *ngIf="getFieldError('email')" class="error-message">
                {{ getFieldError('email') }}
              </span>
            </div>

            <div class="form-group">
              <label for="userName">Nombre de Usuario *</label>
              <input 
                type="text" 
                id="userName" 
                formControlName="userName"
                [class.input-error]="getFieldError('userName')">
              <span *ngIf="getFieldError('userName')" class="error-message">
                {{ getFieldError('userName') }}
              </span>
            </div>
          </div>

          <!-- Contraseñas -->
          <div class="form-row">
            <div class="form-group">
              <label for="password">Contraseña *</label>
              <input 
                type="password" 
                id="password" 
                formControlName="password"
                [class.input-error]="getFieldError('password')">
              <span *ngIf="getFieldError('password')" class="error-message">
                {{ getFieldError('password') }}
              </span>
            </div>

            <div class="form-group">
              <label for="repeatPassword">Repetir Contraseña *</label>
              <input 
                type="password" 
                id="repeatPassword" 
                formControlName="repeatPassword"
                [class.input-error]="getFieldError('repeatPassword')">
              <span *ngIf="getFieldError('repeatPassword')" class="error-message">
                {{ getFieldError('repeatPassword') }}
              </span>
            </div>
          </div>

          <!-- Fecha de Nacimiento -->
          <div class="form-group">
            <label for="birthDate">Fecha de Nacimiento *</label>
            <input 
              type="date" 
              id="birthDate" 
              formControlName="birthDate"
              [class.input-error]="getFieldError('birthDate')">
            <span *ngIf="getFieldError('birthDate')" class="error-message">
              {{ getFieldError('birthDate') }}
            </span>
          </div>

          <!-- Descripción -->
          <div class="form-group">
            <label for="description">Descripción</label>
            <textarea 
              id="description" 
              formControlName="description"
              rows="3"
              placeholder="Breve descripción del usuario..."></textarea>
          </div>

          <!-- Radio buttons para ROL -->
          <div class="form-group">
            <label>Rol del Usuario *</label>
            <div class="radio-group">
              <label class="radio-label">
                <input 
                  type="radio" 
                  formControlName="profile" 
                  value="usuario">
                <span class="radio-custom"></span>
                <span class="radio-text">Usuario</span>
              </label>
              
              <label class="radio-label">
                <input 
                  type="radio" 
                  formControlName="profile" 
                  value="administrador">
                <span class="radio-custom"></span>
                <span class="radio-text">Administrador</span>
              </label>
            </div>
          </div>

          <!-- Botones -->
          <div class="modal-footer">
            <button 
              type="button" 
              class="btn-secondary" 
              (click)="closeCreateModal()"
              [disabled]="isSubmitting()">
              Cancelar
            </button>
            <button 
              type="submit" 
              class="btn-primary"
              [disabled]="isSubmitting()">
              {{ isSubmitting() ? 'Creando...' : 'Crear Usuario' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>


